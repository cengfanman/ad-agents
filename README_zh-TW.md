# Amazon 賣家 AI 智能代理

一個自主 AI 代理，透過動態決策和工具選擇幫助 Amazon 賣家診斷廣告效果問題。

## 專案目標

此專案透過實現自主系統來展示代理架構（非工作流程）：
- 觀察當前情境和數據
- 形成並更新關於問題的假設
- 根據資訊增益動態選擇適當工具
- 基於收集的證據調整策略
- 提供可行的建議

## 快速開始

1. **環境設置**
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # Windows 系統：venv\Scripts\activate
   pip install -r requirements.txt
   ```

2. **運行不同場景**
   ```bash
   # 測試低曝光場景 - 代理應優先進行競價分析
   python demo.py --scenario scenarios/scenario_low_impr.json
   
   # 測試高 ACOS 場景 - 代理應專注於廣泛匹配浪費
   python demo.py --scenario scenarios/scenario_high_acos.json
   
   # 測試轉化問題 - 代理應優先檢查清單品質
   python demo.py --scenario scenarios/scenario_high_click_low_conv.json
   
   # 測試 ≥0.8 信心早期終止（展示立即停止）
   python demo.py --scenario scenarios/scenario_immediate_stop.json
   ```

3. **測試錯誤處理**
   ```bash
   # 模擬競爭對手工具失效以查看回退行為
   python demo.py --scenario scenarios/scenario_low_impr.json --break-competitor
   ```

4. **運行所有場景（煙霧測試）**
   ```bash
   ./scripts/smoke.sh
   ```

## 預期輸出

不同場景會導致不同的代理行為：

- **低曝光** → 代理優先使用 `ads_metrics` 然後 `competitor`（競價/競爭問題）
- **高 ACOS** → 代理專注於 `ads_metrics` 識別浪費，可能檢查 `listing_audit`
- **低轉化** → 代理優先使用 `listing_audit` 然後 `competitor`（品質/競爭）

## 專案結構

```
amazon-agent/
├─ agent/                 # 核心代理邏輯
│  ├─ loop.py            # 觀察→思考→行動主循環（≥3輪）
│  ├─ policy.py          # 假設管理、信念更新、工具選擇
│  ├─ memory.py          # 工作記憶和軌跡記錄
│  ├─ reasoning.py       # 結構化日誌和推理顯示
│  ├─ errors.py          # 錯誤處理和回退策略
│  └─ types.py           # 數據類型定義
├─ tools/                # 代理工具
│  ├─ base.py           # 工具介面和通用功能
│  ├─ ads_metrics.py    # 廣告指標分析
│  ├─ inventory.py      # 庫存狀態檢查
│  ├─ listing_audit.py  # 產品清單品質審計
│  └─ competitor.py     # 競爭對手分析
├─ mock/                # 不同場景的模擬數據
├─ scenarios/           # 場景定義
├─ trace/              # 代理執行軌跡（自動生成）
├─ scripts/            # 測試和工具腳本
└─ demo.py             # 主要命令列介面
```

## 工具與數據架構

### 可用工具

| 工具 | 目的 | 輸入架構 | 主要輸出 |
|------|---------|--------------|-------------|
| **ads_metrics** | 分析關鍵字/廣告活動效果 | `mode: 'keyword'|'campaign'` | CTR、ACOS、曝光模式、轉化問題 |
| **competitor** | 市場競爭分析 | 標準情境 | 價格定位、市場飽和度、競爭壓力 |
| **listing_audit** | 產品清單品質檢查 | 標準情境 | 品質評分、優化建議、轉化影響 |
| **inventory** | 庫存水準和可用性 | 標準情境 | 庫存天數、缺貨風險、廣告支出影響 |

### 數據放置

模擬數據應放置在 `mock/<scenario_name>/` 目錄中：
- `ads_keywords.json` - 關鍵字效果指標（曝光、點擊、CPC、ACOS）
- `ads_campaign.json` - 廣告活動層級效果數據
- `inventory.json` - 庫存水準和補貨資訊
- `listing_audit.json` - 清單品質評分和審計結果
- `competitor.json` - 競爭環境分析

### 證據收集

代理會自動從工具結果中提取證據：
- **強證據** (+0.2)：明確指標（例如：ACOS > 1.0 表示浪費假設）
- **中等證據** (+0.1)：中度指標（例如：CTR < 0.015 表示品質問題）
- **弱證據** (+0.05)：輕微指標（例如：低庫存影響競價）
- **反證據** (-0.1)：與假設相反的證據

## 評估標準對應

### 代理架構（60%）

| 標準 | 實現 |
|-----------|----------------|
| **動態決策能力** | 政策引擎根據當前假設信心和資訊增益潛力選擇工具 |
| **推理可見性** | 結構化控制台日誌顯示觀察/思考/決定/行動階段和信念更新 |
| **工具使用** | 代理根據假設強度和情境自主選擇 4+ 個工具 |
| **錯誤恢復** | 工具失效時的回退機制和替代策略 |

### 工程實現（40%）

| 標準 | 實現 |
|-----------|----------------|
| **代碼品質** | 模組化架構、類型提示、關注點清晰分離 |
| **可執行性** | 單一命令示範，清晰的日誌和軌跡輸出 |
| **時間管理** | 專注於核心代理循環而非外圍功能 |

## 架構設計

### 為何選擇代理而非工作流程
- **工作流程**：固定操作序列（例如：總是運行 ads_metrics → competitor → listing_audit）
- **代理**：基於當前信念和資訊增益潛力的動態決策

代理透過以下方式展現真正的自主性：
- 基於場景目標形成關於潛在問題的假設
- 根據哪個工具能提供最有資訊價值的證據動態選擇工具
- 隨著證據收集更新信念，相應調整策略
- 適應工具失效的回退策略

### 核心循環：觀察 → 思考 → 行動
1. **觀察**：從場景、先前工具結果和當前狀態收集情境
2. **思考**：根據收集的證據更新假設信心分數
3. **決定**：顯示工具映射和使用狀態並選擇下一個工具
4. **行動**：執行選定工具並收集證據，或在足夠信心時終止

**增強決策顯示：**
- **工具映射表**：顯示假設 → 工具映射和即時狀態
- **使用追蹤**：已完成工具的視覺指標（✓）
- **假設狀態標識**：
  - 🔍 標記當前正在調查的假設
  - ⭐ 標記最高信心假設
- **狀態比率**：顯示每個假設的工具完成比率（例如：1/2、2/2）
- **詳細推理**：解釋假設選擇邏輯和工具選擇原因

### 信念系統與資訊增益
- 維持 5 個核心廣告效果問題假設的信心分數（0.0-1.0）
- 證據強度映射：強（+0.2）、中（+0.1）、弱（+0.05）、反（-0.1）
- 基於資訊增益潛力而非固定順序的工具選擇
- 不同場景目標導致不同的初始信念分佈

### 工具選擇啟發式

代理使用假設到工具映射系統以獲得最佳資訊增益：

| 假設 | 主要工具 | 次要工具 | 選擇邏輯 |
|------------|---------------|-----------------|-----------------|
| **H1：低競價** | `ads_metrics` | - | 直接競價效果分析 |
| **H2：關鍵字覆蓋** | `ads_metrics` | `listing_audit` | 關鍵字效果 + 內容分析 |
| **H3：競爭對手壓力** | `competitor` | `ads_metrics` | 市場分析優先，然後效果 |
| **H4：清單品質** | `listing_audit` | `competitor` | 品質審計 + 競爭情境 |
| **H5：廣泛匹配浪費** | `ads_metrics` | - | 直接關鍵字浪費分析 |

**工具選擇過程：**
1. 按信心排序假設（信念分數）
2. 從前 2 個假設的偏好工具中選擇工具
3. 偏好未使用工具以獲得最大資訊增益
4. 如果偏好工具已用盡，回退到任何未使用工具

### 終止標準

代理使用複雜的多層停止機制：

**1. 最小探索要求（硬性要求）**
- 無論信心高低，至少需要 3 個決策循環（作業要求）
- 防止有限數據導致過早結論
- 確保充分的證據收集和分析

**2. 極高信心（≥ 0.8）+ 最小步數**
- 當主要假設達到 80%+ 信心且已完成最少 3 步時終止
- 表示對特定問題有壓倒性證據

**3. 高信心（≥ 0.7）+ 工具完成 + 最小步數**
- 當主要假設達到 70%+ 信心且
- 該假設的所有偏好工具都已執行且
- 已完成至少 3 個決策循環時停止

**4. 最大迭代限制**
- 5 步硬限制以防止無限循環
- 即使證據不確定也確保及時完成

**5. 工具耗盡**
- 當沒有更多資訊工具可用時停止
- 證據收集完成時的優雅終止

**示例決策流程：**
```
步驟 1：信心 0.8 → 繼續（未滿足最少3步要求）
步驟 2：信心 0.8 → 繼續（未滿足最少3步要求）
步驟 3：信心 0.8+ → 停止（滿足最小要求 + 高信心）

作業硬性要求：無論信心多高，都必須至少完成3個決策迭代
```

### 錯誤處理與回退
- 工具超時自動重試（1 次重試，指數退避）
- 工具失效時優雅降級（使用替代工具繼續）
- 回退建議：競爭對手失效 → 使用 listing_audit + ads_metrics
- 測試模式標誌 `--break-competitor` 模擬失效

## 錯誤處理演示

代理包含全面的錯誤處理：

```bash
# 正常執行 - 應成功完成
python demo.py --scenario scenarios/scenario_low_impr.json

# 模擬失效 - 競爭對手工具失效，代理適應
python demo.py --scenario scenarios/scenario_low_impr.json --break-competitor
```

**預期回退行為：**
1. 競爭對手工具因 DataMissingError 失效
2. 代理顯示回退建議：「使用 listing_audit 檢查競爭力」
3. 代理使用替代工具繼續執行
4. 最終建議根據可用數據進行調整

## 測試與驗證

```bash
# 運行全面煙霧測試
./scripts/smoke.sh

# 測試個別場景
python demo.py --scenario scenarios/scenario_low_impr.json          # → 應專注於競價/競爭
python demo.py --scenario scenarios/scenario_high_acos.json         # → 應專注於浪費減少
python demo.py --scenario scenarios/scenario_high_click_low_conv.json # → 應專注於清單品質
```

## 影片演示腳本（5-8 分鐘）

### 第 1 段：設計理念（1-2 分鐘）
- 「這是 AI 代理，不是工作流程 - 它做自主決策」
- 「展示帶有動態工具選擇的觀察-思考-行動循環」
- 「基於證據的信念系統更新，而非固定規則」

### 第 2 段：不同路徑演示（3-4 分鐘）
- **命令 1**：`python demo.py --scenario scenarios/scenario_low_impr.json`
  - 顯示代理優先使用 ads_metrics → competitor（競價/競爭焦點）
  - 指出信念更新和推理
- **命令 2**：`python demo.py --scenario scenarios/scenario_high_acos.json`
  - 顯示不同工具選擇（ads_metrics 優先進行浪費分析）
  - 突出不同的最終建議

### 第 3 段：錯誤處理（1-2 分鐘）
- **命令 3**：`python demo.py --scenario scenarios/scenario_low_impr.json --break-competitor`
- 顯示優雅降級和回退建議
- 展示代理使用替代策略繼續

### 要強調的重點
- **決策日誌**：指出顯示工具選擇推理的「DECIDE」部分
- **信念更新**：突出證據如何改變假設信心
- **最終排名**：顯示不同場景如何導致不同假設排名
- **可行輸出**：準備實施的 JSON + Markdown 建議